<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>영어 학습 도우미</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #3498db;
      --primary-dark: #2980b9;
      --secondary: #2ecc71;
      --bg-page: #f4f7fa;
      --bg-card: #ffffff;
      --text: #333333;
      --text-light: #666666;
      --border-radius: 8px;
      --transition: 0.2s ease;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-page);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
    }
    h1 { text-align: center; font-weight: 600; margin-bottom: 20px; }
    .card {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      margin-bottom: 16px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: border-color var(--transition);
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    button {
      display: inline-block;
      padding: 10px 16px;
      margin-right: 8px;
      margin-bottom: 16px;
      font-size: 1rem;
      font-weight: 500;
      color: #fff;
      background: var(--primary);
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background var(--transition);
    }
    button.secondary {
      background: var(--secondary);
    }
    button:hover {
      background: var(--primary-dark);
    }
    button.secondary:hover {
      background: #27ae60;
    }
    #wordlist-tree details {
      margin-bottom: 8px;
      border: 1px solid #eee;
      border-radius: var(--border-radius);
      padding: 8px 12px;
      background: #fafafa;
    }
    #wordlist-tree summary {
      font-weight: 600;
      cursor: pointer;
      list-style: none;
    }
    #wordlist-tree summary::-webkit-details-marker { display: none; }
    #wordlist-tree summary::before {
      content: '▸';
      display: inline-block;
      margin-right: 6px;
      transition: transform var(--transition);
    }
    #wordlist-tree details[open] summary::before {
      transform: rotate(90deg);
    }
    #wordlist-tree ul {
      list-style: none;
      margin-left: 16px;
      margin-top: 8px;
    }
    #wordlist-tree li {
      padding: 4px 0;
      cursor: pointer;
      color: var(--text-light);
      transition: color var(--transition);
    }
    #wordlist-tree li:hover {
      color: var(--text);
    }
    #slide-area {
      margin-top: 20px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: var(--primary);
      background: #fff;
      border: 2px solid var(--primary);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

  <h1>영어 학습 도우미</h1>

  <div class="card">
    <h2>1. 단어장 저장</h2>
    <label>대분류 (예: 교과서, 모의고사)
      <input id="inputCategory" placeholder="교과서" />
    </label>
    <label>중분류 (예: 올림포스 1강)
      <input id="inputSubcategory" placeholder="올림포스 1강" />
    </label>
    <label>단어장 제목 (예: 올림포스1)
      <input id="inputTitle" placeholder="올림포스1" />
    </label>
    <label>단어·뜻 입력 (예: importance 중요성)
      <textarea id="inputWords" rows="5"></textarea>
    </label>
    <button id="save-wordlist-btn">저장하기</button>
    <button id="load-wordlists-btn" class="secondary">저장된 목록 불러오기</button>
  </div>

  <div class="card">
    <h2>2. 단어장 목록</h2>
    <div id="wordlist-tree"></div>
  </div>

  <div class="card">
    <h2>3. 슬라이드 테스트</h2>
    <button id="start-slide-test-btn" class="secondary">테스트 시작</button>
    <div id="slide-area">여기에 단어가 표시됩니다</div>
  </div>

  <script>
    // utils
    function shuffle(arr) {
      for (let i = arr.length-1; i>0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // 1) 저장
    document.getElementById('save-wordlist-btn').addEventListener('click', async () => {
      const category    = document.getElementById('inputCategory').value.trim();
      const subcategory = document.getElementById('inputSubcategory').value.trim();
      const title       = document.getElementById('inputTitle').value.trim();
      const words = document.getElementById('inputWords').value
        .trim().split('\n')
        .map(l => {
          const [w, ...m] = l.trim().split(/\s+/);
          return { word: w, meaning: m.join(' ') };
        });

      if (!category||!subcategory||!title||!words.length) {
        return alert('모든 항목을 올바르게 입력해주세요.');
      }
      const res = await fetch('/.netlify/functions/save-wordlist', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ category, subcategory, title, words })
      });
      if (!res.ok) {
        const err = await res.json().catch(()=>({error:'unknown'}));
        return alert('저장 실패: '+(err.error||res.status));
      }
      alert('✅ 저장되었습니다!');
    });

    // 2) 목록 불러와 트리 렌더
    async function renderTree() {
      const res = await fetch('/.netlify/functions/list-wordlists');
      if (!res.ok) return alert('목록 불러오기 실패');
      const items = await res.json();
      const root = document.getElementById('wordlist-tree');
      root.innerHTML = '';

      // 그룹핑
      const byCat = items.reduce((a,{category,subcategory,title})=>{
        a[category] = a[category]||{};
        a[category][subcategory] = a[category][subcategory]||[];
        a[category][subcategory].push(title);
        return a;
      }, {});

      Object.entries(byCat).forEach(([cat,submap])=>{
        const d1 = document.createElement('details');
        const s1 = document.createElement('summary');
        s1.textContent = cat;
        d1.appendChild(s1);

        Object.entries(submap).forEach(([sub,list])=>{
          const d2 = document.createElement('details');
          d2.style.marginLeft = '12px';
          const s2 = document.createElement('summary');
          s2.textContent = sub;
          d2.appendChild(s2);

          const ul = document.createElement('ul');
          list.forEach(t=>{
            const li = document.createElement('li');
            li.textContent = t;
            li.style.marginLeft = '16px';
            li.addEventListener('click', ()=>applyList(t));
            ul.appendChild(li);
          });
          d2.appendChild(ul);
          d1.appendChild(d2);
        });
        root.appendChild(d1);
      });
    }
    document.getElementById('load-wordlists-btn').addEventListener('click', renderTree);

    // 3) 단어장 적용
    let currentWords = [];
    async function applyList(title) {
      const res = await fetch(`/.netlify/functions/get-wordlist?title=${encodeURIComponent(title)}`);
      if (!res.ok) return alert('단어장 불러오기 실패');
      currentWords = await res.json();
      alert(`"${title}" 단어장 (${currentWords.length}개) 불러옴`);
    }

    // 4) 슬라이드 테스트
    let intervalId;
    document.getElementById('start-slide-test-btn').addEventListener('click', ()=>{
      if (!currentWords.length) return alert('단어장을 먼저 선택하세요.');
      clearInterval(intervalId);
      const area = document.getElementById('slide-area');
      area.textContent = '';
      const list = shuffle(currentWords.slice()).slice(0,30);
      let idx = 0;
      const show = ()=>{
        if (idx>=list.length) {
          clearInterval(intervalId);
          area.textContent = '✅ 테스트 완료';
          return;
        }
        area.textContent = list[idx].word;
        setTimeout(()=> area.textContent = '', 3000);
        idx++;
      };
      show();
      intervalId = setInterval(show, 6000);
    });
  </script>

</body>
</html>
