<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>영어 학습 도우미</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; background: #f9f9f9; }
    h1, h2 { text-align: center; color: #333; }
    #navigation { text-align: center; margin-bottom: 20px; }
    #navigation button { padding: 10px 15px; margin: 0 5px; cursor: pointer; }
    .feature-section { display: none; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .feature-section.active { display: block; }
    input, textarea { width: 100%; margin-bottom: 10px; padding: 8px; box-sizing: border-box; }
    button { padding: 10px 20px; margin-right: 5px; cursor: pointer; }
    #wordlist-tree { margin-top: 15px; }
    #wordlist-tree h3 { margin: 0.5em 0; cursor: pointer; }
    #wordlist-tree ul { list-style: none; padding-left: 1em; }
    #wordlist-tree li { margin: 0.3em 0; cursor: pointer; }
    #slide-area { margin-top:20px; font-size: 2em; text-align: center; height: 3em; }
  </style>
</head>
<body>

  <h1>영어 학습 도우미</h1>
  <div id="navigation">
    <button id="btn-word-test" class="active">단어 테스트</button>
  </div>

  <!-- 단어 테스트 섹션 -->
  <div id="word-test-section" class="feature-section active">
    <h2>단어장 저장 &amp; 목록</h2>
    <input id="inputCategory"    placeholder="대분류 입력 (예: 교과서, 모의고사)" />
    <input id="inputSubcategory" placeholder="중분류 입력 (예: 올림포스 1강)" />
    <input id="inputTitle"       placeholder="단어장 제목 입력 (예: 올림포스1)" />
    <textarea id="inputWords" rows="6" placeholder="단어·뜻을 한 줄에 하나씩, 띄어쓰기로 구분하여 입력하세요&#10;예) importance 중요성&#10;prominence 두드러짐"></textarea>
    <button id="save-wordlist-btn">단어장 저장</button>
    <button id="load-wordlists-btn">저장된 목록 불러오기</button>

    <div id="wordlist-tree"></div>

    <h2 style="margin-top:40px;">슬라이드 테스트</h2>
    <button id="start-slide-test-btn">테스트 시작</button>
    <div id="slide-area"></div>
  </div>

  <script>
    // ----------------------
    // Helpers
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // ----------------------
    // 저장: save-wordlist
    document.getElementById('save-wordlist-btn').addEventListener('click', async () => {
      const category    = document.getElementById('inputCategory').value.trim();
      const subcategory = document.getElementById('inputSubcategory').value.trim();
      const title       = document.getElementById('inputTitle').value.trim();
      const lines       = document.getElementById('inputWords').value.trim().split('\n');
      const words       = lines.map(l => {
        const [word, ...rest] = l.trim().split(/\s+/);
        return { word, meaning: rest.join(' ') };
      });

      if (!category || !subcategory || !title || words.length === 0) {
        return alert('모든 필드를 올바르게 입력하세요.');
      }

      const resp = await fetch('/.netlify/functions/save-wordlist', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ category, subcategory, title, words })
      });
      if (!resp.ok) {
        const err = await resp.json().catch(()=>({error:'unknown'}));
        return alert('저장 실패: ' + (err.error||resp.status));
      }
      alert('저장되었습니다!');
    });

    // ----------------------
    // 불러오기 목록: 트리 렌더링
    async function renderWordlistTree() {
      const resp = await fetch('/.netlify/functions/list-wordlists');
      if (!resp.ok) {
        return alert('목록 불러오기 실패');
      }
      const items = await resp.json(); 
      // items: [{category, subcategory, title}, …]

      const treeEl = document.getElementById('wordlist-tree');
      treeEl.innerHTML = '';

      // 그룹핑
      const byCat = items.reduce((acc, {category, subcategory, title}) => {
        acc[category] = acc[category] || {};
        acc[category][subcategory] = acc[category][subcategory] || [];
        acc[category][subcategory].push(title);
        return acc;
      }, {});

      // 트리 생성
      Object.entries(byCat).forEach(([cat, subMap]) => {
        const h3 = document.createElement('h3');
        h3.textContent = cat;
        treeEl.appendChild(h3);

        const ul = document.createElement('ul');
        Object.entries(subMap).forEach(([sub, titles]) => {
          const liSub = document.createElement('li');
          liSub.textContent = sub;
          const inner = document.createElement('ul');
          titles.forEach(t => {
            const liTitle = document.createElement('li');
            liTitle.textContent = t;
            liTitle.addEventListener('click', () => applyWordlist(t));
            inner.appendChild(liTitle);
          });
          liSub.appendChild(inner);
          ul.appendChild(liSub);
        });
        treeEl.appendChild(ul);
      });
    }
    document.getElementById('load-wordlists-btn').addEventListener('click', renderWordlistTree);

    // ----------------------
    // 단어장 적용 → 슬라이드 시작 준비
    let currentWords = [];
    async function applyWordlist(title) {
      const resp = await fetch(`/.netlify/functions/get-wordlist?title=${encodeURIComponent(title)}`);
      if (!resp.ok) {
        return alert('단어장 불러오기 실패');
      }
      currentWords = await resp.json();  // [{word,meaning},…]
      alert(`"${title}" 단어장 ${currentWords.length}개 불러옴`);
    }

    // ----------------------
    // 슬라이드 테스트
    let slideInterval;
    function startSlideTest() {
      if (!currentWords.length) {
        return alert('먼저 단어장을 선택해주세요.');
      }
      clearInterval(slideInterval);
      const slideArea = document.getElementById('slide-area');
      slideArea.textContent = '';
      const list = shuffleArray(currentWords.slice()).slice(0, 30);

      let idx = 0;
      function showNext() {
        if (idx >= list.length) {
          clearInterval(slideInterval);
          slideArea.textContent = '테스트 종료';
          return;
        }
        slideArea.textContent = list[idx].word;
        setTimeout(() => {
          slideArea.textContent = '';
          idx++;
        }, 3000);
      }
      showNext();
      slideInterval = setInterval(showNext, 6000);
    }
    document.getElementById('start-slide-test-btn').addEventListener('click', startSlideTest);
  </script>

</body>
</html>
